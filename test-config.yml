version: 2.1

# This is a test configuration to validate the artifactory-orb-v2
# 
# To use this:
# 1. Pack the orb: circleci orb pack src > orb.yml
# 2. Publish as dev: circleci orb publish orb.yml <namespace>/artifactory-orb-v2@dev:test
# 3. Replace the orb reference below with your namespace
# 4. Create a CircleCI project and use this config
# 5. Set environment variables in CircleCI project settings or context:
#    - ARTIFACTORY_URL
#    - ARTIFACTORY_USER
#    - ARTIFACTORY_API_KEY

orbs:
  # Replace with your namespace after publishing
  artifactory: agrasth-test/artifactory-orb-v2@dev:test
  
  # OR for local testing without publishing, you can inline the orb
  # (but this requires manually copying all commands/jobs)

workflows:
  test-orb:
    jobs:
      # Test 1: Install and verify CLI
      - test-install
      
      # Test 2: Configure JFrog CLI
      - test-configure:
          requires:
            - test-install
      
      # Test 3: Upload artifacts using job
      - artifactory/upload:
          name: test-upload-job
          source: "*.txt"
          target: "test-repo/test-${CIRCLE_BUILD_NUM}/"
          build-name: "test-build"
          build-number: "${CIRCLE_BUILD_NUM}"
          url: ${ARTIFACTORY_URL}
          user: ${ARTIFACTORY_USER}
          apikey: ${ARTIFACTORY_API_KEY}
          requires:
            - test-configure

jobs:
  test-install:
    docker:
      - image: cimg/base:stable
    steps:
      - artifactory/install:
          version: "2.54.0"
      - run:
          name: Verify JFrog CLI Installation
          command: |
            echo "Checking JFrog CLI version..."
            jf --version
            echo "JFrog CLI installed successfully!"

  test-configure:
    docker:
      - image: cimg/base:stable
    steps:
      - artifactory/install
      - artifactory/configure:
          server-id: "test-server"
          url: ${ARTIFACTORY_URL}
          user: ${ARTIFACTORY_USER}
          apikey: ${ARTIFACTORY_API_KEY}
      - run:
          name: Verify Configuration
          command: |
            echo "Listing configured servers..."
            jf config show test-server
            echo "Configuration successful!"

  # Example: Manual workflow using commands
  test-manual-upload:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - artifactory/install
      - artifactory/configure:
          server-id: "my-server"
          url: ${ARTIFACTORY_URL}
          user: ${ARTIFACTORY_USER}
          apikey: ${ARTIFACTORY_API_KEY}
      
      # Create test file
      - run:
          name: Create Test Artifacts
          command: |
            echo "Test artifact from CircleCI build ${CIRCLE_BUILD_NUM}" > test-artifact.txt
            echo "Build date: $(date)" >> test-artifact.txt
            ls -la test-artifact.txt
      
      # Upload using command
      - artifactory/upload:
          source: "test-artifact.txt"
          target: "test-repo/circleci-test/"
          server-id: "my-server"
      
      # Collect build info
      - artifactory/build-integration:
          build-name: "manual-test"
          build-number: "${CIRCLE_BUILD_NUM}"
          server-id: "my-server"
      
      # Scan build
      - artifactory/scan:
          build-name: "manual-test"
          build-number: "${CIRCLE_BUILD_NUM}"
          server-id: "my-server"
          fail-build: false

